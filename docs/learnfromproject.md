# NanoGemClaw é–‹ç™¼å­¸ç¿’ç­†è¨˜

> æœ¬æ–‡ä»¶è¨˜éŒ„äº† NanoGemClaw å°ˆæ¡ˆçš„é–‹ç™¼éç¨‹ã€é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆï¼Œä½œç‚ºæ—¥å¾Œå­¸ç¿’åƒè€ƒã€‚

---

## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°

**NanoGemClaw** æ˜¯ä¸€å€‹ Telegram AI åŠ©æ‰‹ï¼Œä½¿ç”¨ Gemini CLI ä½œç‚º AI å¾Œç«¯ï¼Œé‹è¡Œåœ¨ Apple Containerï¼ˆæˆ– Dockerï¼‰æ²™ç›’ç’°å¢ƒä¸­ã€‚

### æŠ€è¡“æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Host (macOS)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   index.ts  â”‚â”€â”€â”€â–¶â”‚  Container (nanogemclaw-agent) â”‚  â”‚
â”‚  â”‚  (Telegram) â”‚â—€â”€â”€â”€â”‚  â””â”€â”€ Gemini CLI                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€â”€ agent-browser             â”‚  â”‚
â”‚         â”‚           â”‚  â””â”€â”€ /workspace (å„ç¾¤çµ„ç¨ç«‹)    â”‚  â”‚
â”‚         â–¼           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚  ~/.gemini  â”‚ â—€â”€â”€ OAuth èªè­‰ã€è¨­å®šæª”ã€Session       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ–‡ä»¶

| æª”æ¡ˆ | åŠŸèƒ½ |
|------|------|
| `src/index.ts` | ä¸»ç¨‹å¼ï¼šTelegram é€£æ¥ã€è¨Šæ¯è·¯ç”±ã€IPC è™•ç† |
| `src/container-runner.ts` | å®¹å™¨ç”Ÿæˆï¼šæ›è¼‰ç›®éŒ„ã€ç’°å¢ƒè®Šæ•¸ã€åŸ·è¡Œå®¹å™¨ |
| `src/config.ts` | é…ç½®ï¼šç’°å¢ƒè®Šæ•¸ã€è·¯å¾‘ã€å¸¸æ•¸ |
| `container/agent-runner/src/index.ts` | å®¹å™¨å…§ Agentï¼šå‘¼å« Gemini CLI |

---

## ğŸ”§ Code Review èˆ‡å„ªåŒ–

### é«˜å„ªå…ˆç´šä¿®å¾©

#### 1. Logger é‡è¤‡å®šç¾©

- **å•é¡Œ**ï¼š`src/index.ts` å…§è¯å®šç¾©äº† loggerï¼Œèˆ‡ `src/logger.ts` é‡è¤‡
- **ä¿®å¾©**ï¼šæ”¹ç”¨ `import { logger } from './logger.js'`
- **å­¸ç¿’**ï¼šé¿å…ä»£ç¢¼é‡è¤‡ï¼Œä½¿ç”¨å…±ç”¨æ¨¡çµ„

#### 2. HTTP ç‹€æ…‹ç¢¼æª¢æŸ¥

- **å•é¡Œ**ï¼š`downloadMedia()` æœªæª¢æŸ¥ HTTP å›æ‡‰ç‹€æ…‹
- **ä¿®å¾©**ï¼šåŠ å…¥ `if (response.statusCode !== 200)` æª¢æŸ¥
- **å­¸ç¿’**ï¼šç¶²è·¯è«‹æ±‚å¿…é ˆè™•ç†éŒ¯èª¤ç‹€æ…‹

```typescript
// Before
https.get(fileUrl, (response) => { response.pipe(file); });

// After
https.get(fileUrl, (response) => {
  if (response.statusCode !== 200) {
    reject(new Error(`HTTP ${response.statusCode}`));
    return;
  }
  response.pipe(file);
});
```

#### 3. ç’°å¢ƒè®Šæ•¸é©—è­‰

- **å•é¡Œ**ï¼š`TELEGRAM_BOT_TOKEN` æœªé©—è­‰å°è‡´é‹è¡Œæ™‚éŒ¯èª¤
- **ä¿®å¾©**ï¼šåœ¨ `config.ts` å•Ÿå‹•æ™‚æª¢æŸ¥ä¸¦é¡¯ç¤ºæ˜ç¢ºéŒ¯èª¤è¨Šæ¯
- **å­¸ç¿’**ï¼šFail fast - å•Ÿå‹•æ™‚å°±æª¢æŸ¥å¿…è¦é…ç½®

### ä¸­å„ªå…ˆç´šä¿®å¾©

#### 4. Telegram é€Ÿç‡é™åˆ¶

- **å•é¡Œ**ï¼šå¤§é‡è¨Šæ¯å¯èƒ½è§¸ç™¼ API é™åˆ¶
- **ä¿®å¾©**ï¼šè¨Šæ¯åˆ†æ®µç™¼é€ä¹‹é–“åŠ å…¥ 100ms å»¶é²
- **å­¸ç¿’**ï¼šå¤–éƒ¨ API å‘¼å«éœ€è€ƒæ…®é€Ÿç‡é™åˆ¶

#### 5. å„ªé›…é—œé–‰

- **å•é¡Œ**ï¼šCtrl+C æ™‚æœªå„²å­˜ç‹€æ…‹
- **ä¿®å¾©**ï¼šåŠ å…¥ SIGINT/SIGTERM è™•ç†å™¨
- **å­¸ç¿’**ï¼šç¨‹åºé—œé–‰å‰æ‡‰æ¸…ç†è³‡æº

#### 6. dotenv è¼‰å…¥

- **å•é¡Œ**ï¼š`telegram-setup.ts` æœªè¼‰å…¥ `.env`
- **ä¿®å¾©**ï¼šåŠ å…¥ `import 'dotenv/config'`
- **å­¸ç¿’**ï¼šç¨ç«‹è…³æœ¬ä¹Ÿéœ€è¦è¼‰å…¥ç’°å¢ƒè®Šæ•¸

### ä½å„ªå…ˆç´šä¿®å¾©

#### 7. åª’é«”æ¸…ç†ç­–ç•¥

- **å•é¡Œ**ï¼šä¸‹è¼‰çš„åª’é«”æª”æ¡ˆæœƒç„¡é™ç´¯ç©
- **ä¿®å¾©**ï¼šåŠ å…¥å®šæ™‚æ¸…ç†ï¼Œåˆªé™¤ 7 å¤©å‰çš„æª”æ¡ˆï¼Œæ¯ 6 å°æ™‚åŸ·è¡Œ
- **å­¸ç¿’**ï¼šé•·æœŸé‹è¡Œçš„æœå‹™éœ€è¦è³‡æºæ¸…ç†æ©Ÿåˆ¶

---

## ğŸ› é‡å¤§ Bug ä¿®å¾©

### Apple Container æ›è¼‰å•é¡Œ

**ç—‡ç‹€**ï¼š

```
Exit code 1: config.js:549
syscall: 'mkdir'
path: '/home/node/.gemini/tmp/.../chats'
```

**æ ¹æœ¬åŸå› **ï¼š

- `~/.gemini` ä»¥ `readonly: true` æ›è¼‰
- Apple Container **ä¸æ”¯æ´å­ç›®éŒ„è¦†è“‹æ›è¼‰**
- å³ä½¿å–®ç¨æ›è¼‰ `/home/node/.gemini/tmp` ç‚ºå¯å¯«ï¼Œä¹Ÿç„¡æ³•è¦†è“‹ readonly çš„çˆ¶ç›®éŒ„
- Gemini CLI éœ€è¦åœ¨ `~/.gemini/tmp/` å¯«å…¥ session è³‡æ–™

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

```typescript
// container-runner.ts
mounts.push({
  hostPath: hostGeminiDir,
  containerPath: '/home/node/.gemini',
  readonly: false,  // æ”¹ç‚ºå¯å¯«
});
```

**é—œéµå­¸ç¿’**ï¼š

1. Apple Container èˆ‡ Docker çš„æ›è¼‰è¡Œç‚ºä¸åŒ
2. å­ç›®éŒ„è¦†è“‹æ›è¼‰åœ¨æŸäº›å®¹å™¨é‹è¡Œæ™‚ä¸å¯é 
3. èª¿è©¦å®¹å™¨å•é¡Œæ™‚ï¼Œå…ˆç”¨ `container run` ç›´æ¥æ¸¬è©¦

### Gemini CLI é…ç½®å•é¡Œ

**ç—‡ç‹€**ï¼šå®¹å™¨å»ºç½®æˆåŠŸä½† CLI å•Ÿå‹•å¤±æ•—

**è§£æ±ºéç¨‹**ï¼š

1. æª¢æŸ¥ `~/.gemini/` ç›®éŒ„çµæ§‹
2. ç™¼ç¾ç¼ºå°‘ `settings.json`
3. ä½¿ç”¨ `gemini` å‘½ä»¤åˆå§‹åŒ–é…ç½®
4. ç¢ºèªå¿…è¦æª”æ¡ˆï¼š
   - `settings.json` - CLI è¨­å®š
   - `google_accounts.json` - å¸³è™Ÿè³‡è¨Š
   - `oauth_creds.json` - OAuth token

---

## ğŸ“¦ å®¹å™¨æ¶æ§‹å­¸ç¿’

### Apple Container vs Docker

| ç‰¹æ€§ | Apple Container | Docker |
|------|-----------------|--------|
| æ›è¼‰èªæ³• | `--mount` / `-v` | `-v` |
| å­ç›®éŒ„è¦†è“‹ | âŒ ä¸æ”¯æ´ | âœ… æ”¯æ´ |
| ç³»çµ±éœ€æ±‚ | macOS only | è·¨å¹³å° |
| æœå‹™ç®¡ç† | `container system start` | `dockerd` |

### æ›è¼‰ç­–ç•¥

```typescript
// åªè®€æ›è¼‰ï¼ˆç”¨æ–¼ä¸å¯è®Šè³‡æºï¼‰
args.push('--mount', `type=bind,source=${path},target=${target},readonly`);

// è®€å¯«æ›è¼‰ï¼ˆç”¨æ–¼éœ€è¦å¯«å…¥çš„ç›®éŒ„ï¼‰
args.push('-v', `${path}:${target}`);
```

### å®¹å™¨èª¿è©¦æŠ€å·§

```bash
# ç›´æ¥æ¸¬è©¦å®¹å™¨
container run --rm -i \
  -v /Users/ä½ çš„ç”¨æˆ¶/.gemini:/home/node/.gemini \
  nanogemclaw-agent:latest << 'EOF'
{"prompt":"æ¸¬è©¦è¨Šæ¯","groupFolder":"test","chatJid":"test@g.us","isMain":false}
EOF

# æª¢æŸ¥å®¹å™¨æœå‹™ç‹€æ…‹
container system status

# åˆ—å‡ºæ‰€æœ‰æ˜ åƒ
container images list
```

---

## ğŸŒ å¤šèªç³» README

ç‚ºå°ˆæ¡ˆåŠ å…¥äº† 5 ç¨®èªè¨€çš„ READMEï¼š

| èªè¨€ | æª”æ¡ˆ |
|------|------|
| English | `README.md` |
| ç¹é«”ä¸­æ–‡ | `README.zh-TW.md` |
| ç®€ä½“ä¸­æ–‡ | `README.zh-CN.md` |
| EspaÃ±ol | `README.es.md` |
| æ—¥æœ¬èª | `README.ja.md` |

**èªè¨€åˆ‡æ›å™¨**ï¼šæ¯å€‹ README é ‚éƒ¨éƒ½æœ‰é€£çµå¯åˆ‡æ›èªè¨€

---

## ğŸ“ é–‹ç™¼ç¶“é©—ç¸½çµ

### è‰¯å¥½å¯¦è¸

1. **Fail Fast** - å•Ÿå‹•æ™‚æª¢æŸ¥å¿…è¦é…ç½®
2. **å…±ç”¨æ¨¡çµ„** - é¿å…ä»£ç¢¼é‡è¤‡
3. **éŒ¯èª¤è™•ç†** - ç¶²è·¯è«‹æ±‚ã€æª”æ¡ˆæ“ä½œéƒ½éœ€è¦
4. **è³‡æºæ¸…ç†** - å®šæœŸæ¸…ç†æš«å­˜æª”æ¡ˆ
5. **å„ªé›…é—œé–‰** - è™•ç† SIGINT/SIGTERM

### èª¿è©¦æµç¨‹

1. **çœ‹éŒ¯èª¤è¨Šæ¯** - ä»”ç´°é–±è®€éŒ¯èª¤å †ç–Š
2. **ç¸®å°ç¯„åœ** - ç”¨æœ€å°å¯é‡ç¾æ¡ˆä¾‹æ¸¬è©¦
3. **ç›´æ¥æ¸¬è©¦** - ç¹éæ‡‰ç”¨ç¨‹å¼ç›´æ¥æ¸¬è©¦çµ„ä»¶
4. **æª¢æŸ¥å‡è¨­** - å®¹å™¨è¡Œç‚ºå¯èƒ½èˆ‡é æœŸä¸åŒ

### TypeScript æŠ€å·§

```typescript
// ç’°å¢ƒè®Šæ•¸é©—è­‰
if (!process.env.TOKEN) {
  console.error('TOKEN not set');
  process.exit(1);
}

// éåŒæ­¥å»¶é²
await new Promise(r => setTimeout(r, 100));

// å®‰å…¨çš„ç›®éŒ„å‰µå»º
fs.mkdirSync(path, { recursive: true });
```

---

## ğŸ”— ç›¸é—œè³‡æº

- [Gemini CLI](https://github.com/google-gemini/gemini-cli)
- [Apple Container](https://developer.apple.com/documentation/virtualization)
- [node-telegram-bot-api](https://github.com/yagop/node-telegram-bot-api)
- [åŸå§‹ NanoClaw](https://github.com/gavrielc/nanoclaw)

---

*æœ€å¾Œæ›´æ–°ï¼š2026-02-05*
